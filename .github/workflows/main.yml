name: "‚ö° EnigMano (V26 - Tailscale Ultimate + 19GB RAM)"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "Instance ID"
        required: true
        default: "1"
      RDP_PASS:
        description: "Set RDP Password"
        required: true
        default: "Enigma@123"

jobs:
  deploy-v26-tailscale:
    name: "üöÄ Deploy Instance ${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-latest
    timeout-minutes: 350

    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      RDP_PASSWORD: ${{ github.event.inputs.RDP_PASS }}
      
      # üîó YOUR TOOLS
      LINK_TWO: "https://fn-sorter-pro.streamlit.app/"
      LINK_THREE: "https://miri1408x-create.github.io/txt-merger/"
      # üì¶ DROPBOX LINK
      ZIP_URL: "https://www.dropbox.com/scl/fi/xqqk8u72nvgia7wpgswnc/Fortnite-V7.zip?rlkey=s6g9fgvitjnbz3sdjmbmou4ga&st=t5oyksu3&dl=1"

    steps:
      # ---------------------------------------------------------
      # STEP 1: SYSTEM PREP & 19GB RAM BOOST
      # ---------------------------------------------------------
      - name: üîß System Prep & RAM Boost
        shell: pwsh
        run: |
          Write-Host "==============================================="
          Write-Host "üîπ Target Instance ID    : $env:INSTANCE_ID"
          Write-Host "üöÄ Strategy              : V26 (Tailscale Ultimate)"
          Write-Host "‚ö° Upgrade               : 19GB RAM + Active Security Killer"
          Write-Host "==============================================="

          # 1. üöÄ 12GB PAGEFILE BOOST (Guarantees High Specs)
          $regPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management"
          $pageData = "C:\pagefile.sys 12288 12288" 
          Set-ItemProperty -Path $regPath -Name "PagingFiles" -Value $pageData -Type MultiString -Force
          Write-Host "‚úÖ Virtual RAM Boosted to 19GB."

          # 2. üõ°Ô∏è DISABLE "MARK OF THE WEB" & SECURITY POPUPS
          $policyPath = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Attachments"
          if (-not (Test-Path $policyPath)) { New-Item -Path $policyPath -Force | Out-Null }
          Set-ItemProperty -Path $policyPath -Name "SaveZoneInformation" -Value 1 -Type DWord -Force
          
          $assocPath = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Associations"
          if (-not (Test-Path $assocPath)) { New-Item -Path $assocPath -Force | Out-Null }
          Set-ItemProperty -Path $assocPath -Name "LowRiskFileTypes" -Value ".exe;.bat;.cmd;.vbs;.zip;.rar;.rdp;.msi" -Force

          # 3. üöÄ ENABLE HIGH PERFORMANCE
          powercfg -setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c

          # 4. üõë DISABLE BLOATWARE
          Stop-Service -Name "wuauserv" -Force; Set-Service -Name "wuauserv" -StartupType Disabled
          Stop-Service -Name "WSearch" -Force; Set-Service -Name "WSearch" -StartupType Disabled

          # 5. RDP Setup (Create User)
          $user = "RDP"
          $pass = ConvertTo-SecureString $env:RDP_PASSWORD -AsPlainText -Force
          New-LocalUser -Name $user -Password $pass -Description "Enigma User" -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $user
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      # ---------------------------------------------------------
      # STEP 2: TAILSCALE CONNECTION
      # ---------------------------------------------------------
      - name: üîå Connect Tailscale
        shell: pwsh
        run: |
          if (-not $env:TAILSCALE_AUTH_KEY) { Write-Error "‚ùå Missing Secret: TAILSCALE_AUTH_KEY"; exit 1 }
          
          # Install
          choco install tailscale -y --no-progress
          
          # Connect
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$env:TAILSCALE_AUTH_KEY" --hostname="Enigma-$env:INSTANCE_ID" --ssh --accept-routes
          
          # Get IP
          Start-Sleep -Seconds 10
          $tsIP = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          echo "TS_IP=$tsIP" >> $env:GITHUB_ENV
          
          Write-Host "‚úÖ Connected to Tailscale Grid."
          Write-Host "üåê Internal IP: $tsIP"

      # ---------------------------------------------------------
      # STEP 3: PRE-DOWNLOAD & SECURITY KILLER
      # ---------------------------------------------------------
      - name: üõ†Ô∏è Setup Active Protection & Launch
        shell: pwsh
        run: |
          $dlDir = "C:\Users\RDP\Downloads"
          New-Item -ItemType Directory -Path $dlDir -Force | Out-Null

          # 1. Pre-Download Zip (Bypasses Chrome)
          Invoke-WebRequest "$env:ZIP_URL" -OutFile "$dlDir\Fortnite-V7.zip" -UseBasicParsing
          Unblock-File "$dlDir\Fortnite-V7.zip"

          # 2. Setup Auto-Launch Script
          $chromePath = "C:\Program Files\Google\Chrome\Application\chrome.exe"
          $startupFolder = "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp"
          $autoLaunchPath = "$startupFolder\InstantLaunch.bat"
          
          $batchContent = @"
          @echo off
          :: Background Security Killer (Unblocks files every 1s)
          start "" powershell -WindowStyle Hidden -Command "while(\$true) { Get-ChildItem 'C:\Users\RDP\Downloads\*' -Recurse | Unblock-File; Start-Sleep -Seconds 1 }"
          
          :: Open Tabs
          start "" "$chromePath" "$env:LINK_TWO" "$env:LINK_THREE"
          
          :: Open Folder
          explorer.exe "C:\Users\RDP\Downloads"
          "@
          
          Set-Content -Path $autoLaunchPath -Value $batchContent
          Write-Host "‚úÖ Auto-Launch Configured."

      # ---------------------------------------------------------
      # STEP 4: NOTIFICATIONS & LOOP
      # ---------------------------------------------------------
      - name: üîî Send Info to Discord
        shell: pwsh
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if ($env:DISCORD_WEBHOOK) {
            $payload = @{
              content = "‚úÖ **Enigma V26 (Tailscale) Ready!**`n`nüåê **Tailscale IP:** `$env:TS_IP``nüë§ **User:** RDP`nüîë **Pass:** $env:RDP_PASSWORD`n‚ö° **Specs:** 19GB RAM / Active Security Killer"
            }
            $json = $payload | ConvertTo-Json
            try { Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -Body $json -ContentType 'application/json' } catch {}
          }

      - name: ‚öîÔ∏è Maintain Session
        shell: pwsh
        run: |
          Write-Host "üö¶ Session Active. Max Duration: 350 Minutes."
          while ($true) { Start-Sleep -Seconds 60; Write-Host "‚è≥ Active - IP: $env:TS_IP" }
